// Generated by CIRCT firtool-1.62.1
module Im2ColStreamerNCHW(
  input        clock,
               reset,
  input  [7:0] io_in_0,
               io_in_1,
               io_in_2,
               io_in_3,
               io_in_4,
               io_in_5,
               io_in_6,
               io_in_7,
               io_in_8,
               io_in_9,
               io_in_10,
               io_in_11,
               io_in_12,
               io_in_13,
               io_in_14,
               io_in_15,
               io_in_16,
               io_in_17,
               io_in_18,
               io_in_19,
               io_in_20,
               io_in_21,
               io_in_22,
               io_in_23,
               io_in_24,
  input  [2:0] io_oh,
               io_ow,
  input        io_start,
  output [7:0] io_a_out,
  output       io_valid
);

  reg              running;
  reg  [3:0]       kIdx;
  wire [3:0]       rem = kIdx % 4'h9;
  wire [3:0]       kwIdx = rem % 4'h3;
  wire [31:0][7:0] _GEN =
    {{io_in_0},
     {io_in_0},
     {io_in_0},
     {io_in_0},
     {io_in_0},
     {io_in_0},
     {io_in_0},
     {io_in_24},
     {io_in_23},
     {io_in_22},
     {io_in_21},
     {io_in_20},
     {io_in_19},
     {io_in_18},
     {io_in_17},
     {io_in_16},
     {io_in_15},
     {io_in_14},
     {io_in_13},
     {io_in_12},
     {io_in_11},
     {io_in_10},
     {io_in_9},
     {io_in_8},
     {io_in_7},
     {io_in_6},
     {io_in_5},
     {io_in_4},
     {io_in_3},
     {io_in_2},
     {io_in_1},
     {io_in_0}};
  always @(posedge clock) begin
    if (reset) begin
      running <= 1'h0;
      kIdx <= 4'h0;
    end
    else begin
      automatic logic _GEN_0;
      _GEN_0 = kIdx == 4'h8;
      running <= io_start | ~(running & _GEN_0) & running;
      if (io_start)
        kIdx <= 4'h0;
      else if (~running | _GEN_0) begin
      end
      else
        kIdx <= kIdx + 4'h1;
    end
  end // always @(posedge)
  assign io_a_out =
    running
      ? _GEN[({1'h0, kIdx / 4'h9} * 5'h5 + {1'h0, {1'h0, io_oh} + rem / 4'h3}) * 5'h5
        + {2'h0, io_ow + {1'h0, kwIdx[1:0]}}]
      : 8'h0;
  assign io_valid = running;
endmodule

module PEFixed(
  input  [7:0]  io_a_in,
                io_b_in,
  input  [31:0] io_psum_in,
  output [31:0] io_psum_out
);

  wire [15:0] prod = {{8{io_a_in[7]}}, io_a_in} * {{8{io_b_in[7]}}, io_b_in};
  assign io_psum_out = io_psum_in + {{16{prod[15]}}, prod};
endmodule

module SystolicArrayMatVecFixed(
  input  [7:0]  io_a_in_0_0,
                io_a_in_0_1,
                io_b_in_0,
                io_b_in_1,
  input  [31:0] io_psum_in_0,
  output [31:0] io_psum_out_0
);

  wire [31:0] _pe_io_psum_out;
  PEFixed pe (
    .io_a_in     (io_a_in_0_0),
    .io_b_in     (io_b_in_0),
    .io_psum_in  (io_psum_in_0),
    .io_psum_out (_pe_io_psum_out)
  );
  PEFixed pe_1 (
    .io_a_in     (io_a_in_0_1),
    .io_b_in     (io_b_in_1),
    .io_psum_in  (_pe_io_psum_out),
    .io_psum_out (io_psum_out_0)
  );
endmodule

module RegularConvFull_SA_KTile(
  input  [7:0]  io_x_tile_0,
                io_x_tile_1,
                io_w_tile_0_0,
                io_w_tile_0_1,
  input  [31:0] io_psum_in_0,
  output [31:0] io_psum_out_0
);

  SystolicArrayMatVecFixed sa (
    .io_a_in_0_0   (io_w_tile_0_0),
    .io_a_in_0_1   (io_w_tile_0_1),
    .io_b_in_0     (io_x_tile_0),
    .io_b_in_1     (io_x_tile_1),
    .io_psum_in_0  (io_psum_in_0),
    .io_psum_out_0 (io_psum_out_0)
  );
endmodule

module RegularConvFull_SA_Tiled(
  input         clock,
                reset,
                io_start,
  input  [7:0]  io_x_in_0_0,
                io_x_in_0_1,
                io_x_in_0_2,
                io_x_in_0_3,
                io_x_in_0_4,
                io_x_in_0_5,
                io_x_in_0_6,
                io_x_in_0_7,
                io_x_in_0_8,
                io_x_in_0_9,
                io_x_in_0_10,
                io_x_in_0_11,
                io_x_in_0_12,
                io_x_in_0_13,
                io_x_in_0_14,
                io_x_in_0_15,
                io_x_in_0_16,
                io_x_in_0_17,
                io_x_in_0_18,
                io_x_in_0_19,
                io_x_in_0_20,
                io_x_in_0_21,
                io_x_in_0_22,
                io_x_in_0_23,
                io_x_in_0_24,
                io_w_in_0_0,
                io_w_in_0_1,
                io_w_in_0_2,
                io_w_in_0_3,
                io_w_in_0_4,
                io_w_in_0_5,
                io_w_in_0_6,
                io_w_in_0_7,
                io_w_in_0_8,
  output [31:0] io_y_out_0_0,
                io_y_out_0_1,
                io_y_out_0_2,
                io_y_out_0_3,
                io_y_out_0_4,
                io_y_out_0_5,
                io_y_out_0_6,
                io_y_out_0_7,
                io_y_out_0_8,
  output        io_done
);

  wire [31:0]      _core_io_psum_out_0;
  wire [7:0]       _im2col_io_a_out;
  wire             _im2col_io_valid;
  reg  [31:0]      yReg_0_0;
  reg  [31:0]      yReg_0_1;
  reg  [31:0]      yReg_0_2;
  reg  [31:0]      yReg_0_3;
  reg  [31:0]      yReg_0_4;
  reg  [31:0]      yReg_0_5;
  reg  [31:0]      yReg_0_6;
  reg  [31:0]      yReg_0_7;
  reg  [31:0]      yReg_0_8;
  reg              doneReg;
  reg  [3:0]       posReg;
  wire [3:0]       _im2col_io_oh_T = posReg / 4'h3;
  wire [3:0]       _im2col_io_ow_T = posReg % 4'h3;
  reg  [31:0]      psumReg_0;
  reg  [7:0]       buf0_0;
  reg  [7:0]       buf0_1;
  reg  [7:0]       buf1_0;
  reg  [7:0]       buf1_1;
  reg              bufSel;
  reg  [3:0]       gkIdx;
  reg              capIdx;
  reg  [2:0]       tileIdx;
  reg              compValid;
  reg              compBufSel;
  reg  [2:0]       compTileIdx;
  reg              compLastTile;
  wire [4:0]       _GEN = {1'h0, compTileIdx, 1'h0};
  wire [15:0][7:0] _GEN_0 =
    {{io_w_in_0_0},
     {io_w_in_0_0},
     {io_w_in_0_0},
     {io_w_in_0_0},
     {io_w_in_0_0},
     {io_w_in_0_0},
     {io_w_in_0_0},
     {io_w_in_0_8},
     {io_w_in_0_7},
     {io_w_in_0_6},
     {io_w_in_0_5},
     {io_w_in_0_4},
     {io_w_in_0_3},
     {io_w_in_0_2},
     {io_w_in_0_1},
     {io_w_in_0_0}};
  wire [4:0]       _idx_T_1 = _GEN + 5'h1;
  reg  [2:0]       state;
  wire             _GEN_1 = state == 3'h0;
  wire             _GEN_2 = state == 3'h1;
  always @(posedge clock) begin
    if (reset) begin
      yReg_0_0 <= 32'h0;
      yReg_0_1 <= 32'h0;
      yReg_0_2 <= 32'h0;
      yReg_0_3 <= 32'h0;
      yReg_0_4 <= 32'h0;
      yReg_0_5 <= 32'h0;
      yReg_0_6 <= 32'h0;
      yReg_0_7 <= 32'h0;
      yReg_0_8 <= 32'h0;
      doneReg <= 1'h0;
      posReg <= 4'h0;
      psumReg_0 <= 32'h0;
      buf0_0 <= 8'h0;
      buf0_1 <= 8'h0;
      buf1_0 <= 8'h0;
      buf1_1 <= 8'h0;
      bufSel <= 1'h0;
      gkIdx <= 4'h0;
      capIdx <= 1'h0;
      tileIdx <= 3'h0;
      compValid <= 1'h0;
      compBufSel <= 1'h0;
      compTileIdx <= 3'h0;
      compLastTile <= 1'h0;
      state <= 3'h0;
    end
    else begin
      automatic logic _GEN_3;
      automatic logic _GEN_4 = _GEN_1 | _GEN_2;
      automatic logic _GEN_5;
      automatic logic _GEN_6;
      automatic logic isLastGlobal;
      automatic logic isTileEnd;
      automatic logic _GEN_7;
      automatic logic _GEN_8;
      automatic logic _GEN_9;
      automatic logic _GEN_10;
      _GEN_3 = state == 3'h2;
      _GEN_5 = posReg == 4'h8;
      _GEN_6 = _GEN_3 & _im2col_io_valid;
      isLastGlobal = gkIdx == 4'h8;
      isTileEnd = capIdx | isLastGlobal;
      _GEN_7 = _im2col_io_valid & isTileEnd;
      _GEN_8 = _GEN_3 & _GEN_7;
      _GEN_9 = state == 3'h3;
      _GEN_10 = state == 3'h4;
      if (_GEN_4 | ~(_GEN_3 & compValid & compLastTile & posReg == 4'h0)) begin
      end
      else
        yReg_0_0 <= _core_io_psum_out_0;
      if (_GEN_4 | ~(_GEN_3 & compValid & compLastTile & posReg == 4'h1)) begin
      end
      else
        yReg_0_1 <= _core_io_psum_out_0;
      if (_GEN_4 | ~(_GEN_3 & compValid & compLastTile & posReg == 4'h2)) begin
      end
      else
        yReg_0_2 <= _core_io_psum_out_0;
      if (_GEN_4 | ~(_GEN_3 & compValid & compLastTile & posReg == 4'h3)) begin
      end
      else
        yReg_0_3 <= _core_io_psum_out_0;
      if (_GEN_4 | ~(_GEN_3 & compValid & compLastTile & posReg == 4'h4)) begin
      end
      else
        yReg_0_4 <= _core_io_psum_out_0;
      if (_GEN_4 | ~(_GEN_3 & compValid & compLastTile & posReg == 4'h5)) begin
      end
      else
        yReg_0_5 <= _core_io_psum_out_0;
      if (_GEN_4 | ~(_GEN_3 & compValid & compLastTile & posReg == 4'h6)) begin
      end
      else
        yReg_0_6 <= _core_io_psum_out_0;
      if (_GEN_4 | ~(_GEN_3 & compValid & compLastTile & posReg == 4'h7)) begin
      end
      else
        yReg_0_7 <= _core_io_psum_out_0;
      if (_GEN_4 | ~(_GEN_3 & compValid & compLastTile & _GEN_5)) begin
      end
      else
        yReg_0_8 <= _core_io_psum_out_0;
      doneReg <= ~_GEN_1 & (~(_GEN_2 | _GEN_3 | _GEN_9) & _GEN_10 | doneReg);
      if (_GEN_1) begin
        posReg <= 4'h0;
        if (io_start)
          state <= 3'h1;
      end
      else begin
        automatic logic _GEN_11;
        _GEN_11 = compValid & compLastTile;
        if (_GEN_2 | ~(_GEN_3 & _GEN_11) | _GEN_5) begin
        end
        else
          posReg <= posReg + 4'h1;
        if (_GEN_2) begin
          if (_im2col_io_valid) begin
          end
          else
            state <= 3'h2;
        end
        else if (_GEN_3) begin
          if (_GEN_11)
            state <= _GEN_5 ? 3'h4 : 3'h3;
        end
        else if (_GEN_9) begin
          if (_im2col_io_valid) begin
          end
          else
            state <= 3'h1;
        end
        else if (_GEN_10 & ~io_start)
          state <= 3'h0;
      end
      if (_GEN_4) begin
        psumReg_0 <= 32'h0;
        gkIdx <= 4'h0;
        tileIdx <= 3'h0;
      end
      else begin
        if (_GEN_3 & compValid)
          psumReg_0 <= _core_io_psum_out_0;
        if (_GEN_6)
          gkIdx <= gkIdx + 4'h1;
        if (_GEN_8)
          tileIdx <= tileIdx + 3'h1;
      end
      if (_GEN_4 | ~(_GEN_3 & _im2col_io_valid & ~bufSel & ~capIdx)) begin
      end
      else
        buf0_0 <= _im2col_io_a_out;
      if (_GEN_4 | ~(_GEN_3 & _im2col_io_valid & ~bufSel & capIdx)) begin
      end
      else
        buf0_1 <= _im2col_io_a_out;
      if (_GEN_4 | ~_GEN_6 | ~bufSel | capIdx) begin
      end
      else
        buf1_0 <= _im2col_io_a_out;
      if (_GEN_4 | ~(_GEN_6 & bufSel & capIdx)) begin
      end
      else
        buf1_1 <= _im2col_io_a_out;
      bufSel <= ~_GEN_4 & (_GEN_8 ^ bufSel);
      capIdx <= ~_GEN_4 & (_GEN_6 ? ~isTileEnd & capIdx - 1'h1 : capIdx);
      compValid <= ~_GEN_4 & (_GEN_3 ? _GEN_7 : compValid);
      if (_GEN_4 | ~_GEN_8) begin
      end
      else begin
        compBufSel <= bufSel;
        compTileIdx <= tileIdx;
        compLastTile <= isLastGlobal;
      end
    end
  end // always @(posedge)
  Im2ColStreamerNCHW im2col (
    .clock    (clock),
    .reset    (reset),
    .io_in_0  (io_x_in_0_0),
    .io_in_1  (io_x_in_0_1),
    .io_in_2  (io_x_in_0_2),
    .io_in_3  (io_x_in_0_3),
    .io_in_4  (io_x_in_0_4),
    .io_in_5  (io_x_in_0_5),
    .io_in_6  (io_x_in_0_6),
    .io_in_7  (io_x_in_0_7),
    .io_in_8  (io_x_in_0_8),
    .io_in_9  (io_x_in_0_9),
    .io_in_10 (io_x_in_0_10),
    .io_in_11 (io_x_in_0_11),
    .io_in_12 (io_x_in_0_12),
    .io_in_13 (io_x_in_0_13),
    .io_in_14 (io_x_in_0_14),
    .io_in_15 (io_x_in_0_15),
    .io_in_16 (io_x_in_0_16),
    .io_in_17 (io_x_in_0_17),
    .io_in_18 (io_x_in_0_18),
    .io_in_19 (io_x_in_0_19),
    .io_in_20 (io_x_in_0_20),
    .io_in_21 (io_x_in_0_21),
    .io_in_22 (io_x_in_0_22),
    .io_in_23 (io_x_in_0_23),
    .io_in_24 (io_x_in_0_24),
    .io_oh    (_im2col_io_oh_T[2:0]),
    .io_ow    ({1'h0, _im2col_io_ow_T[1:0]}),
    .io_start (~_GEN_1 & _GEN_2 & ~_im2col_io_valid),
    .io_a_out (_im2col_io_a_out),
    .io_valid (_im2col_io_valid)
  );
  RegularConvFull_SA_KTile core (
    .io_x_tile_0   (compBufSel ? buf1_0 : buf0_0),
    .io_x_tile_1   (compBufSel ? buf1_1 : buf0_1),
    .io_w_tile_0_0 (_GEN < 5'h9 ? _GEN_0[{compTileIdx, 1'h0}] : 8'h0),
    .io_w_tile_0_1 (_idx_T_1 < 5'h9 ? _GEN_0[_idx_T_1[3:0]] : 8'h0),
    .io_psum_in_0  (psumReg_0),
    .io_psum_out_0 (_core_io_psum_out_0)
  );
  assign io_y_out_0_0 = yReg_0_0;
  assign io_y_out_0_1 = yReg_0_1;
  assign io_y_out_0_2 = yReg_0_2;
  assign io_y_out_0_3 = yReg_0_3;
  assign io_y_out_0_4 = yReg_0_4;
  assign io_y_out_0_5 = yReg_0_5;
  assign io_y_out_0_6 = yReg_0_6;
  assign io_y_out_0_7 = yReg_0_7;
  assign io_y_out_0_8 = yReg_0_8;
  assign io_done = doneReg;
endmodule

